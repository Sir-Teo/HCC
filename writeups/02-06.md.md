### Training Methodology for HCC Recurrence Prediction

#### 1. **Introduction**

#### 2. **Data Preparation**
The dataset consists of pre-operative MRI scans stored in DICOM format, along with patient labels indicating recurrence status and time-to-event data. The data preparation pipeline involves the following steps:

- **DICOM Data Loading**: The `HCCDicomDataset` class is responsible for loading DICOM files, extracting axial slices, and converting them into tensors. The dataset is split into training, validation, and test sets using stratified sampling to ensure balanced representation of recurrence events across splits.
  
- **Preprocessing**: Each DICOM slice is normalized and resized to a standard size (224x224 pixels). The pixel values are normalized using windowing for CT images and min-max normalization for MRI images. The dataset also supports caching preprocessed tensors to disk to speed up subsequent training runs.

- **Feature Extraction**: The DINOv2 model, pre-trained on a large dataset, is used to extract features from the MRI slices. The feature extraction process involves averaging the features across slices to obtain a single feature vector per patient.

#### 3. **Model Architecture**
The model architecture consists of two main components:

- **DINOv2 Feature Extractor**: The DINOv2 model is a Vision Transformer (ViT) pre-trained using self-supervised learning. It is used to extract high-level features from the MRI slices. The model is frozen during training, meaning its weights are not updated.

- **CoxPH Model with L1/L2 Regularization**: The CoxPH model is used to predict the risk of HCC recurrence. The model is implemented with an optional Multi-Layer Perceptron (MLP) or a simple linear layer. The MLP consists of two hidden layers with ReLU activation and dropout for regularization. The CoxPH loss is combined with an L1/L2 regularization term to control the complexity of the model and prevent overfitting.

#### 4. **Training Process**
The training process involves the following steps:

- **Data Loading**: The `HCCDataModule` class handles the loading of data into PyTorch DataLoader objects. The data is batched and shuffled appropriately for training, validation, and testing.

- **Feature Extraction**: The DINOv2 model is used to extract features from the MRI slices. The features are averaged across slices to obtain a single feature vector per patient. The features are then standardized using `StandardScaler` to have zero mean and unit variance.

- **Upsampling**: To address class imbalance, the training data is upsampled to ensure that both recurrence and non-recurrence events are equally represented. This is done by randomly sampling from the minority class until both classes have the same number of samples.

- **Model Training**: The CoxPH model is trained using the Adam optimizer with a learning rate of 1e-8. The loss function combines the Cox partial likelihood loss with an L1/L2 regularization term. The regularization weight (`alpha`) and the relative weight between L1 and L2 (`gamma`) are hyperparameters that can be tuned.

- **Early Stopping**: Training is monitored using early stopping based on the validation loss. If the validation loss does not improve for a specified number of epochs, training is stopped to prevent overfitting.

- **Gradient Clipping**: To prevent exploding gradients, gradient clipping is applied during training. The gradient clipping threshold is set to 0.05.

#### 5. **Evaluation Metrics**
The model is evaluated using several metrics:

- **Concordance Index (C-Index)**: The C-Index measures the model's ability to correctly rank patients by their risk of recurrence. A C-Index of 1.0 indicates perfect ranking, while 0.5 indicates random ranking.

- **Brier Score**: The Brier Score measures the accuracy of predicted survival probabilities. It is computed at multiple time points and averaged to obtain the integrated Brier score.

- **Integrated Negative Binomial Log-Likelihood (NBLL)**: The NBLL measures the quality of the predicted survival probabilities. Lower values indicate better predictions.

- **Kaplan-Meier Survival Curves**: The Kaplan-Meier estimator is used to visualize the survival probabilities for different risk groups. The log-rank test is used to compare the survival curves of high-risk and low-risk groups.

- **Calibration Plot**: The calibration plot compares the predicted survival probabilities with the observed survival probabilities at a fixed time point (e.g., 24 months). A well-calibrated model should have predicted probabilities close to the observed probabilities.

#### 6. **Results and Interpretation**
The training process produces several outputs:

- **Training Log**: The training loss and validation loss are plotted over epochs to monitor the training process. The plot helps identify overfitting or underfitting.

- **Survival Functions**: The predicted survival functions for a subset of test samples are plotted to visualize the model's predictions.

- **Risk Stratification**: Patients are stratified into high-risk and low-risk groups based on the median predicted risk score. The Kaplan-Meier survival curves for these groups are plotted and compared using the log-rank test.

- **Calibration Plot**: The calibration plot shows how well the predicted survival probabilities match the observed survival probabilities at a fixed time point.

- **Additional Statistics**: The model reports additional statistics, such as the mean and standard deviation of the predicted risk scores, the median survival time for each risk group, and the observed survival probability at a fixed time point.

#### 7. **Conclusion**
The proposed methodology combines deep learning feature extraction with a regularized CoxPH model to predict HCC recurrence from pre-operative MRI scans. The use of DINOv2 for feature extraction allows the model to leverage high-level features learned from a large dataset, while the CoxPH model with L1/L2 regularization ensures robust predictions. The training process is carefully designed to handle the challenges of medical imaging data, including class imbalance and high-dimensional features. The evaluation metrics provide a comprehensive assessment of the model's performance, including its ability to rank patients by risk, predict survival probabilities, and stratify patients into risk groups.

This methodology can be extended to other medical imaging tasks by adapting the feature extraction and survival analysis components to the specific characteristics of the data and the clinical question at hand.